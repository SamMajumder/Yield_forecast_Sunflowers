---
title: "Historic Climate Data Preprocess"
output: html_notebook
---

**Load the libraries**

```{r}

packages <- c("tidyverse","readxl","here","lubridate")

lapply(packages, require,character.only =T)

```

**Importing the historical weather data and preprocessing it** 

The historical weather data is in the subfolder called Historical_Weather_Data 
(Main folder is Raw_Datasets).

The data is 5km x 5km gridded monthly precipitation, maximum and minimum temperature 
data acquired from NOAA. Link (https://www.ncei.noaa.gov/data/nclimgrid-monthly/access/) 

Name of the datasets on this database are as follows: 
1. nclimgrid_prcp.nc (Monthly precipitation data)
2. nclimgrid_tmin.nc (Monthly minimum temperature)
3. nclimgrid_tmax.nc (Monthly maximum temperature)  

The following steps were performed to extract data from each of the 
aforementioned NetCDF raster files as csv. It should be mentioned that 
data was extracted at the county centroids: 

a) Import the Study_coordinates.csv file into ArcGIS Pro as point data on a map
b) Make sure the coordinate system is Albers North American Confocal Conic (USGS)
c) Import NetCDF raster data on the existing map/project
d) Subset the NetCDF raster data by timeframe beginning at 1976 and ending at
2022. Make sure the coordinate system is Albers North American Confocal Conic (USGS)
e) Use Sample tool to extract data at points. The points are the county centroids.
(Process as Multidimensional)
f) This results in a Table which is then displayed on the map. 
g) Spatial join is then used to join the table containing weather data to the 
table containing the coordinates of the counties from the Study_coordinates.csv file. 
h) The combined table is then exported from ArcGIS Pro as an excel file.

Then the following code is applied on the excel files containing the historical
weather data to preprocess them further.


```{r}

###############################################
############### First preprocessing the T_min dataframe ###
###################################

Tmin <- read_excel(here("Raw_Datasets",
                      "Historical_Weather_Data",
                      "Historical_Tmin_1976_2022.xlsx")) %>% 
                   mutate(StdTime = as.Date(StdTime)) %>% 
                   mutate(full_Date = format(StdTime,format = "%Y %b %d")) %>%
                   separate(full_Date, into = c("YEAR","MONTH","DAY"), 
                            sep = " ") %>% 
                  select(-c(DAY,OBJECTID,Join_Count,TARGET_FID,LOCATIONID,X,Y,
                            StdTime,Dimensions)) %>% 
                  pivot_wider(names_from =  MONTH,
                              values_from = tmin) %>% 
                  select(-state_name)

#### renaming the names of the dataframe ##### 

Old_names <- colnames(Tmin)

New_names <- c("State","County","Longitude","Latitude",
               "Year","Jan_Tmin","Feb_Tmin","Mar_Tmin",
               "Apr_Tmin","May_Tmin","Jun_Tmin","Jul_Tmin",
               "Aug_Tmin","Sep_Tmin","Oct_Tmin","Nov_Tmin",
               "Dec_Tmin")


Tmin <- Tmin %>% rename_at(vars(Old_names), ~ New_names)




#######################################
############### Now for the Tmax data #### 
################


Tmax <- read_excel(here("Raw_Datasets",
                        "Historical_Weather_Data",
                        "Historical_Tmax_1976_2022.xlsx")) %>% 
        mutate(StdTime = as.Date(StdTime)) %>% 
        mutate(full_Date = format(StdTime,format = "%Y %b %d")) %>%
        separate(full_Date, into = c("YEAR","MONTH","DAY"), 
           sep = " ") %>% 
        select(-c(DAY,OBJECTID,Join_Count,TARGET_FID,LOCATIONID,X,Y,
            StdTime,Dimensions)) %>% 
        pivot_wider(names_from =  MONTH,
              values_from = tmax) %>% 
        select(-state_name)

#### renaming the names of the dataframe ##### 

Old_names <- colnames(Tmax)

New_names <- c("State","County","Longitude","Latitude",
               "Year","Jan_Tmax","Feb_Tmax","Mar_Tmax",
               "Apr_Tmax","May_Tmax","Jun_Tmax","Jul_Tmax",
               "Aug_Tmax","Sep_Tmax","Oct_Tmax","Nov_Tmax",
               "Dec_Tmax")


Tmax <- Tmax %>% rename_at(vars(Old_names), ~ New_names)



#######################################
###### Now preprocessing the Precipitation data ###
########################## 

Precip <- read_excel(here("Raw_Datasets",
                        "Historical_Weather_Data",
                        "Historical_Precip_1976_2022.xlsx")) %>% 
          mutate(StdTime = as.Date(StdTime)) %>% 
          mutate(full_Date = format(StdTime,format = "%Y %b %d")) %>%
          separate(full_Date, into = c("YEAR","MONTH","DAY"), 
           sep = " ") %>% 
          select(-c(DAY,OBJECTID,Join_Count,TARGET_FID,LOCATIONID,X,Y,
            StdTime,Dimensions)) %>% 
          pivot_wider(names_from =  MONTH,
              values_from = prcp) %>% 
          select(-state_name)

#### renaming the names of the dataframe ##### 

Old_names <- colnames(Precip)

New_names <- c("State","County","Longitude","Latitude",
               "Year","Jan_Precip","Feb_Precip","Mar_Precip",
               "Apr_Tmin","May_Tmin","Jun_Tmin","Jul_Precip",
               "Aug_Precip","Sep_Precip","Oct_Precip","Nov_Precip",
               "Dec_Precip")


Precip <- Precip %>% rename_at(vars(Old_names), ~ New_names)




####### Now merging the three dataframes together 

Climate_data <- list(Tmax,Tmin,Precip) %>% 
                                        reduce(inner_join,
                                               by = c("Longitude",
                                                      "Latitude"))

``` 


Exporting this data to a folder called Processed_Datasets 

```{r}

##### writing out this file ###

write.csv(Climate_data,
          "~/Yield_forecast_Sunflowers/Yield_forecast_Sunflowers/Processed_Datasets/Climate_data.csv",
          row.names = FALSE)

```





